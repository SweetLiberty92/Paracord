name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: "true"
  LIVEKIT_VERSION: "v1.9.11"

jobs:
  # ── Build server binary with embedded web UI + LiveKit ────────────────────
  build-server:
    name: Build Server (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            livekit_archive: livekit_${LIVEKIT_VERSION}_windows_amd64.zip
            livekit_bin: livekit-server.exe
            server_bin: paracord-server.exe
            archive_ext: zip
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2

      # Build web client for embedding
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install client dependencies
        working-directory: client
        run: npm install
      - name: Build client
        working-directory: client
        run: npm run build

      # Build server with embedded UI
      - name: Build server
        run: cargo build --release --bin paracord-server

      # Download LiveKit server binary
      - name: Download LiveKit
        shell: pwsh
        run: |
          $version = "${{ env.LIVEKIT_VERSION }}"
          $versionNum = $version.TrimStart("v")
          $url = "https://github.com/livekit/livekit/releases/download/${version}/livekit_${versionNum}_windows_amd64.zip"
          Write-Host "Downloading LiveKit from: $url"
          Invoke-WebRequest -Uri $url -OutFile livekit.zip
          Expand-Archive livekit.zip -DestinationPath livekit-extracted -Force
          # Find the binary (may be nested)
          $bin = Get-ChildItem -Path livekit-extracted -Recurse -Filter "livekit-server.exe" | Select-Object -First 1
          if ($bin) {
            Copy-Item $bin.FullName target/release/livekit-server.exe
            Write-Host "LiveKit binary found: $($bin.FullName)"
          } else {
            Write-Host "WARNING: livekit-server.exe not found in archive, listing contents:"
            Get-ChildItem -Path livekit-extracted -Recurse | ForEach-Object { Write-Host $_.FullName }
          }

      # Package server distribution
      - name: Package server
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          New-Item -ItemType Directory -Path dist/paracord-server -Force

          Copy-Item target/release/paracord-server.exe dist/paracord-server/

          # Copy LiveKit if it was found
          if (Test-Path target/release/livekit-server.exe) {
            Copy-Item target/release/livekit-server.exe dist/paracord-server/
          }

          Copy-Item config/paracord.example.toml dist/paracord-server/

          # Create a quick-start readme
          @"
          Paracord Server v${version}
          ========================

          Quick Start:
            1. Double-click paracord-server.exe
            2. A config file will be auto-generated on first run
            3. Share the public URL shown in the console with friends!

          Configuration:
            - Edit config/paracord.toml to change settings
            - The file is auto-created on first run with secure random secrets

          Voice/Video:
            - livekit-server.exe is bundled and starts automatically
            - No additional setup needed for voice and screen sharing

          Port Forwarding:
            - UPnP is enabled by default and will auto-forward ports
            - If UPnP fails, manually forward TCP port 8080 and TCP/UDP 7880-7892
          "@ | Out-File -FilePath dist/paracord-server/README.txt -Encoding UTF8

          Compress-Archive -Path dist/paracord-server/* -DestinationPath "dist/paracord-server-windows-x64-${version}.zip"

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-windows
          path: dist/paracord-server-windows-x64-*.zip

  # ── Build Tauri desktop client + Inno Setup installer ─────────────────────
  build-client:
    name: Build Client (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: client/src-tauri

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install client dependencies
        working-directory: client
        run: npm install

      # Build the Tauri desktop app
      - name: Build Tauri app
        working-directory: client
        run: npx tauri build

      # Download WebView2 bootstrapper for Inno Setup
      - name: Download WebView2 bootstrapper
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" `
            -OutFile installer/MicrosoftEdgeWebview2Setup.exe

      # Build the Inno Setup installer
      - name: Build installer
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAppVersion=$version `
            installer/paracord-client.iss

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-windows-installer
          path: installer/output/Paracord-Setup-*.exe

      # Also upload the raw Tauri NSIS installer as an alternative
      - name: Upload Tauri NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: client-windows-nsis
          path: client/src-tauri/target/release/bundle/nsis/*.exe

  # ── Create GitHub Release ─────────────────────────────────────────────────
  release:
    name: Create Release
    needs: [build-server, build-client]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          body: |
            ## Downloads

            | Component | File | Description |
            |-----------|------|-------------|
            | **Server** | `paracord-server-windows-x64-*.zip` | Self-contained server with LiveKit bundled. Just extract and run! |
            | **Client (Installer)** | `Paracord-Setup-*.exe` | Windows installer with Start Menu shortcuts and WebView2 setup |

            ## Quick Start

            ### Server Host
            1. Download and extract the server zip
            2. Run `paracord-server.exe` — config is auto-generated on first run
            3. Share the public URL shown in the console with friends

            ### Client Users
            1. Download and run `Paracord-Setup-*.exe`
            2. Enter the server URL (e.g., `73.45.123.99:8080`)
            3. Create an account and start chatting!
          files: |
            artifacts/server-windows/*.zip
            artifacts/client-windows-installer/*.exe
