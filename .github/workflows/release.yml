name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: "true"
  LIVEKIT_VERSION: "v1.9.11"
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  build-server-windows:
    name: Build Server (Windows x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Build embedded web client
        working-directory: client
        run: npm run build

      - name: Build server binary
        run: cargo build --release --bin paracord-server

      - name: Download LiveKit (Windows)
        shell: pwsh
        run: |
          $version = "${{ env.LIVEKIT_VERSION }}"
          $versionNum = $version.TrimStart("v")
          $url = "https://github.com/livekit/livekit/releases/download/${version}/livekit_${versionNum}_windows_amd64.zip"
          Invoke-WebRequest -Uri $url -OutFile livekit.zip
          Expand-Archive livekit.zip -DestinationPath livekit-extracted -Force
          $bin = Get-ChildItem -Path livekit-extracted -Recurse -Filter "livekit-server.exe" | Select-Object -First 1
          if (-not $bin) { throw "livekit-server.exe not found in downloaded archive" }
          Copy-Item $bin.FullName target/release/livekit-server.exe -Force

      - name: Package server (Windows)
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          $pkgDir = "dist/paracord-server"
          New-Item -ItemType Directory -Path $pkgDir -Force | Out-Null

          Copy-Item target/release/paracord-server.exe "$pkgDir/paracord-server.exe" -Force
          Copy-Item target/release/livekit-server.exe "$pkgDir/livekit-server.exe" -Force
          Copy-Item config/paracord.example.toml "$pkgDir/paracord.example.toml" -Force

          @"
          Paracord Server v${version}
          ========================

          Included binaries:
            - paracord-server.exe
            - livekit-server.exe
          "@ | Out-File -FilePath "$pkgDir/README.txt" -Encoding UTF8

          Compress-Archive -Path "$pkgDir/*" -DestinationPath "dist/paracord-server-windows-x64-${version}.zip" -Force

      - name: Upload server artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: server-windows
          path: dist/paracord-server-windows-x64-*.zip

  build-server-linux:
    name: Build Server (Linux x64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Build embedded web client
        working-directory: client
        run: npm run build

      - name: Build server binary
        run: cargo build --release --bin paracord-server

      - name: Download LiveKit (Linux)
        shell: bash
        run: |
          set -euo pipefail
          version="${LIVEKIT_VERSION}"
          version_num="${version#v}"
          url="https://github.com/livekit/livekit/releases/download/${version}/livekit_${version_num}_linux_amd64.tar.gz"
          curl -fsSL "$url" -o livekit.tar.gz
          mkdir -p livekit-extracted
          tar -xzf livekit.tar.gz -C livekit-extracted
          livekit_bin="$(find livekit-extracted -type f -name livekit-server | head -n1)"
          if [ -z "$livekit_bin" ]; then
            echo "livekit-server not found in downloaded archive"
            exit 1
          fi
          cp "$livekit_bin" target/release/livekit-server
          chmod +x target/release/livekit-server

      - name: Package server (Linux)
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          pkg_dir="dist/paracord-server"
          mkdir -p "$pkg_dir"

          cp target/release/paracord-server "$pkg_dir/paracord-server"
          cp target/release/livekit-server "$pkg_dir/livekit-server"
          cp config/paracord.example.toml "$pkg_dir/paracord.example.toml"

          cat > "$pkg_dir/README.txt" <<EOF
          Paracord Server v${version}
          ========================

          Included binaries:
            - paracord-server
            - livekit-server
          EOF

          tar -czf "dist/paracord-server-linux-x64-${version}.tar.gz" -C dist paracord-server

      - name: Verify LiveKit included in Linux tarball
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          tar -tzf "dist/paracord-server-linux-x64-${version}.tar.gz" | grep -q "livekit-server"

      - name: Upload server artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: server-linux
          path: dist/paracord-server-linux-x64-*.tar.gz

  build-client-windows:
    name: Build Client (Windows x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: client/src-tauri

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Validate updater signing key
        shell: pwsh
        run: |
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY) {
            throw "TAURI_SIGNING_PRIVATE_KEY secret is required for signed updater artifacts."
          }

      - name: Build Tauri bundles (Windows)
        working-directory: client
        run: npx tauri build

      - name: Download WebView2 bootstrapper
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" -OutFile installer/MicrosoftEdgeWebview2Setup.exe

      - name: Build Inno installer
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DAppVersion=$version installer/paracord-client.iss

      - name: Upload client installer (Inno)
        uses: actions/upload-artifact@v4
        with:
          name: client-windows-installer
          path: installer/output/Paracord-Setup-*.exe

      - name: Upload client MSI
        uses: actions/upload-artifact@v4
        with:
          name: client-windows-msi
          path: |
            client/src-tauri/target/release/bundle/msi/*.msi
            client/src-tauri/target/release/bundle/msi/*.msi.sig

  build-client-linux:
    name: Build Client (Linux x64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies for Tauri
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libglib2.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev \
            libasound2-dev
          if apt-cache show libayatana-appindicator3-dev >/dev/null 2>&1; then
            sudo apt-get install -y libayatana-appindicator3-dev
          else
            sudo apt-get install -y libappindicator3-dev
          fi

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: client/src-tauri

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Validate updater signing key
        run: |
          set -euo pipefail
          if [ -z "${TAURI_SIGNING_PRIVATE_KEY:-}" ]; then
            echo "TAURI_SIGNING_PRIVATE_KEY secret is required for signed updater artifacts."
            exit 1
          fi

      - name: Build Tauri bundles (AppImage + deb)
        working-directory: client
        run: npx tauri build --bundles appimage,deb

      - name: Upload client AppImage
        uses: actions/upload-artifact@v4
        with:
          name: client-linux-appimage
          path: |
            client/src-tauri/target/release/bundle/appimage/*.AppImage
            client/src-tauri/target/release/bundle/appimage/*.AppImage.sig

      - name: Upload client deb
        uses: actions/upload-artifact@v4
        with:
          name: client-linux-deb
          path: |
            client/src-tauri/target/release/bundle/deb/*.deb
            client/src-tauri/target/release/bundle/deb/*.deb.sig

  release:
    name: Create Release
    needs:
      - build-server-windows
      - build-server-linux
      - build-client-windows
      - build-client-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Generate updater manifest (latest.json)
        shell: bash
        run: |
          set -euo pipefail

          version="${GITHUB_REF_NAME#v}"
          tag="${GITHUB_REF_NAME}"
          repo="${GITHUB_REPOSITORY}"
          pub_date="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          msi_path="$(find artifacts/client-windows-msi -maxdepth 1 -type f -name '*.msi' | head -n1)"
          msi_sig_path="${msi_path}.sig"
          appimage_path="$(find artifacts/client-linux-appimage -maxdepth 1 -type f -name '*.AppImage' | head -n1)"
          appimage_sig_path="${appimage_path}.sig"
          deb_path="$(find artifacts/client-linux-deb -maxdepth 1 -type f -name '*.deb' | head -n1)"
          deb_sig_path="${deb_path}.sig"

          for required in "$msi_path" "$msi_sig_path" "$appimage_path" "$appimage_sig_path" "$deb_path" "$deb_sig_path"; do
            if [ ! -f "$required" ]; then
              echo "Required updater artifact missing: $required"
              exit 1
            fi
          done

          msi_name="$(basename "$msi_path")"
          appimage_name="$(basename "$appimage_path")"
          deb_name="$(basename "$deb_path")"

          msi_sig="$(tr -d '\r\n' < "$msi_sig_path")"
          appimage_sig="$(tr -d '\r\n' < "$appimage_sig_path")"
          deb_sig="$(tr -d '\r\n' < "$deb_sig_path")"

          msi_url="https://github.com/${repo}/releases/download/${tag}/${msi_name}"
          appimage_url="https://github.com/${repo}/releases/download/${tag}/${appimage_name}"
          deb_url="https://github.com/${repo}/releases/download/${tag}/${deb_name}"

          jq -n \
            --arg version "$version" \
            --arg notes "Signed desktop update ${version}" \
            --arg pub_date "$pub_date" \
            --arg msi_url "$msi_url" \
            --arg msi_sig "$msi_sig" \
            --arg appimage_url "$appimage_url" \
            --arg appimage_sig "$appimage_sig" \
            --arg deb_url "$deb_url" \
            --arg deb_sig "$deb_sig" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "windows-x86_64": { url: $msi_url, signature: $msi_sig },
                "linux-x86_64": { url: $deb_url, signature: $deb_sig },
                "linux-x86_64-deb": { url: $deb_url, signature: $deb_sig },
                "linux-x86_64-appimage": { url: $appimage_url, signature: $appimage_sig }
              }
            }' > artifacts/latest.json

          cat artifacts/latest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          body: |
            ## Downloads

            | Component | File |
            |-----------|------|
            | Server (Windows x64) | `paracord-server-windows-x64-*.zip` |
            | Server (Linux x64) | `paracord-server-linux-x64-*.tar.gz` |
            | Client Installer (Windows) | `Paracord-Setup-*.exe` |
            | Client MSI (Windows) | `Paracord_*_x64_en-US.msi` |
            | Client AppImage (Linux) | `Paracord_*.AppImage` |
            | Client deb (Linux) | `paracord_*_amd64.deb` |
            | Signed updater manifest | `latest.json` |
          files: |
            artifacts/server-windows/*.zip
            artifacts/server-linux/*.tar.gz
            artifacts/client-windows-installer/*.exe
            artifacts/client-windows-msi/*.msi
            artifacts/client-windows-msi/*.msi.sig
            artifacts/client-linux-appimage/*.AppImage
            artifacts/client-linux-appimage/*.AppImage.sig
            artifacts/client-linux-deb/*.deb
            artifacts/client-linux-deb/*.deb.sig
            artifacts/latest.json
